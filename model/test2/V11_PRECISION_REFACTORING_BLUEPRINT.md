# üéØ V11 PRECISION REFACTORING BLUEPRINT (THE "PIXEL PERFECT" BIBLE)

**–°—Ç–∞—Ç—É—Å:** –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è –ò–ò. –õ—é–±–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ = –ü—Ä–æ–≤–∞–ª.
**–¶–µ–ª—å:** –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ `model/test1` –≤ `model/test2` —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º 100% –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –Ω—é–∞–Ω—Å–æ–≤ –¥–ª—è Panel.

---

## üé® –°–ª–æ–π 1: –¶–≤–µ—Ç–∞ –∏ –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ (Single Source of Truth)

| –≠–ª–µ–º–µ–Ω—Ç | –¢–æ—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ `test1` | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ |
| :--- | :--- | :--- |
| **Call Candle** | `#76D7C4` | –ó–µ–ª–µ–Ω—ã–π –∏–∑—É–º—Ä—É–¥ |
| **Put Candle** | `#FF8787` | –ö–æ—Ä–∞–ª–ª–æ–≤—ã–π –∫—Ä–∞—Å–Ω—ã–π |
| **Greeks (IV..Vega)** | `[#9B59B6, #E67E22, #3498DB, #F1C40F, #1ABC9C]` | –ü–ª–æ—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞, –Ω–µ –ø–∞—Å—Ç–µ–ª—å |
| **Spot Asset** | `#969696` | –ü—É–Ω–∫—Ç–∏—Ä–Ω–∞—è –ª–∏–Ω–∏—è `line_dash='dashed'` |
| **Background** | `#FFFFFF` | –ß–∏—Å—Ç–æ –±–µ–ª—ã–π, –Ω–∏–∫–∞–∫–∏—Ö "smoke" –æ—Ç—Ç–µ–Ω–∫–æ–≤ |
| **Grid Lines** | `#E0E0E0`, `alpha=0.3` | –¢–æ–Ω–∫–∏–µ, –ø–æ—á—Ç–∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ |
| **–®—Ä–∏—Ñ—Ç—ã UI** | `'SF Mono', Monaco, monospace` | –î–ª—è –ª–µ–≥–µ–Ω–¥ –∏ –ø–∞–Ω–µ–ª–µ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
| **–®—Ä–∏—Ñ—Ç—ã –û—Å–µ–π** | `-apple-system, BlinkMacSystemFont, 'Segoe UI'` | –î–ª—è –ø–æ–¥–ø–∏—Å–µ–π –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ö |

---

## üìè –°–ª–æ–π 2: –û–ø–æ—Ä–Ω—ã–µ –°–µ—Ç–∫–∏ –∏ –¢–∏–∫–∏ (Precision Specs)

### 2.1 Strike Chart (Bokeh Stack)
*   **–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ (The Zero Gap Rule):**
    *   –í—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ –≤ —Å—Ç–µ–∫–µ: `min_border_left=50`, `min_border_right=50`.
    *   `margin=0`, `spacing=0` –≤ `bokeh.models.column`.
    *   `outline_line_color=None` (–≥—Ä–∞—Ñ–∏–∫–∏ –¥–æ–ª–∂–Ω—ã "—Å–ª–∏–≤–∞—Ç—å—Å—è").
*   **–û—Å—å Y (Main):**
    *   `major_tick_in=2`, `major_tick_out=2`.
    *   `major_label_text_font_size='7pt'`.
    *   `axis_label_text_font_size='8pt'`, `font_style='bold'`.
    *   `ticker=BasicTicker(desired_num_ticks=5)`.
*   **–û—Å—å Y (Greek):**
    *   –ß–∏—Å–ª–∞ –°–õ–ï–í–ê (`yaxis_location='left'`).
    *   –ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä–µ–∫–∞ (IV, Œî –∏ —Ç.–¥.) –°–ü–†–ê–í–ê —á–µ—Ä–µ–∑ `LinearAxis` –Ω–∞ `extra_y_ranges`.
    *   –¶–≤–µ—Ç –ø—Ä–∞–≤–æ–π –º–µ—Ç–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ü–≤–µ—Ç—É –≥—Ä–µ–∫–∞, —à—Ä–∏—Ñ—Ç `'8pt'`, `bold`.
*   **–û—Å—å X (Global):**
    *   –í–∏–¥–∏–º–∞ **–¢–û–õ–¨–ö–û** –Ω–∞ –Ω–∏–∂–Ω–µ–º –≥—Ä–∞—Ñ–∏–∫–µ (`SharedAxisPlot`).
    *   –§–æ—Ä–º–∞—Ç: `%d %b` (–¥–Ω–∏) –∏ `%b %Y` (–º–µ—Å—è—Ü—ã).
    *   `major_tick_line_color='#CCCCCC'`.

---

## ‚ö° –°–ª–æ–π 3: –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∏ –í–æ—Ä–∫–∞—É–Ω–¥—ã (The Functional Core)

### 3.1 –ö—Ä–æ—Å—Å—Ö–µ–π—Ä (Crosshair Sync)
*   –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π `CrosshairTool`.
*   **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `Span` (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –ø—É–Ω–∫—Ç–∏—Ä) –Ω–∞ –∫–∞–∂–¥–æ–º –ø–æ–¥-–≥—Ä–∞—Ñ–∏–∫–µ.
*   **–¢—Ä–∏–≥–≥–µ—Ä:** `CustomJS` –Ω–∞ `HoverTool` –æ–±–Ω–æ–≤–ª—è–µ—Ç `location` –≤—Å–µ—Ö `Span` –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
*   **Hide:** `js_on_event('mouseleave')` –¥–æ–ª–∂–µ–Ω –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞—Ç—å –≤—Å–µ `Span`.

### 3.2 –ê–≤—Ç–æ–º–∞—Å—à—Ç–∞–± (AutoScale Engine)
*   **–õ–æ–≥–∏–∫–∞:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ `x_range.start/end` (Pan/Zoom), —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–º—É `datasource` –∏ –Ω–∞—Ö–æ–¥–∏—Ç `min/max` –≤–Ω—É—Ç—Ä–∏ –æ–∫–Ω–∞.
*   **Padding:** 
    *   Main: `12%` (OHLC), `8%` (Spot).
    *   Greeks: `15%`.
*   **JS:** –û—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, –Ω–∏–∫–∞–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–µ—Ä—É Python –≤–æ –≤—Ä–µ–º—è –∑—É–º–∞.

### 3.3 –õ–∏–ø–∫–∏–µ –ú–µ—Ç–∫–∏ (Sticky Labels)
*   **Spot Label:** –í—Å–µ–≥–¥–∞ —É –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è. –§–æ–Ω: `#FFFFFF`, `alpha=0.9`. –ì—Ä–∞–Ω–∏—Ü–∞ –≤ —Ü–≤–µ—Ç –ª–∏–Ω–∏–∏.
*   **Option Price Label:** –í—Å–µ–≥–¥–∞ —É –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è.
*   **JS-Link:** `label.x = x_range.start/end` –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–æ–±—ã—Ç–∏—è–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–Ω–¥–∂–∞.

---

## üß± –°–ª–æ–π 4: –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (Control Plane)

### 4.1 –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –í—ã—Å–æ—Ç—ã
*   **–ê–ª–≥–æ—Ä–∏—Ç–º:** `main_height = total * (1 - sum(0.25/2**i))`.
*   –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –≥—Ä–µ–∫–∞ (Toggle) –≤—ã—Å–æ—Ç—ã –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –¥–æ–ª–∂–Ω—ã –ø–ª–∞–≤–Ω–æ –∏–ª–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (JS) –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å—Å—è.
*   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `get_layout_manager_js` –∏–∑ `test1` –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

### 4.2 –õ–µ–≥–µ–Ω–¥–∞ (Interactive Legend)
*   **–¢–∏–ø:** `bokeh.models.Div`.
*   **–ö–æ–Ω—Ç–µ–Ω—Ç:** HTML-—Å—Ç—Ä–æ–∫–∞ —Å `tabular-nums` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è "–ø—Ä—ã–∂–∫–æ–≤" —Ü–∏—Ñ—Ä –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏.
*   **–§–æ—Ä–º–∞—Ç:** `O:123.45 H:123.45 L:123.45 C:123.45`. –¶–≤–µ—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å–≤–µ—á–∞–º.

---

## üõ†Ô∏è –°–ª–æ–π 5: Integration Bridge (Panel implementation)

–ú—ã –ù–ï –ø–∏—à–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ–¥ Panel. –ú—ã –ø–∏—à–µ–º **Stand-alone –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**, –∫–æ—Ç–æ—Ä—ã–µ Panel –≤—Å—Ç–∞–≤–ª—è–µ—Ç "as-is".

1.  **`StrikeChart`**: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `bokeh.models.Column`.
2.  **`SmileChart`**: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `pn.pane.HTML` (—Å–æ–¥–µ—Ä–∂–∏—Ç Jinja2 —à–∞–±–ª–æ–Ω + CSS Grid). 
    *   *–ö—Ä–∏—Ç–∏—á–Ω–æ:* –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª–∞—Å—Å—ã `.layout-1`..`.layout-5` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏—è —Å–µ—Ç–∫–∏ –≥—Ä–µ–∫–æ–≤.
3.  **`SurfaceChart`**: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `pn.pane.HTML` —Å Plotly-–∫–∞—Ä—Ç–æ—á–∫–∞–º–∏.

---

## üìù –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ò–ò-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:

1.  [ ] **`bokeh_components.py`**: –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã `UIFactory`, `HeightCalculator` –∏ –≤—Å–µ `COLORS`.
2.  [ ] **`bokeh_workarounds.py`**: –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ 19 —Ñ–∏–∫—Å–æ–≤, –≤–∫–ª—é—á–∞—è `SharedAxisPlot`.
3.  [ ] **`strike_chart.py`**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω `finalize_layout` —Å —Å–∫—Ä—ã—Ç–∏–µ–º –æ—Å–µ–π.
4.  [ ] **`smile_chart.py`**: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `Jinja2` —à–∞–±–ª–æ–Ω —Å CSS-—Ç–µ–Ω—è–º–∏ –∫–∞—Ä—Ç–æ—á–µ–∫.
5.  [ ] **`test_data.py`**: –ß–∏—Å—Ç–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤.

---
**–ú–ê–ù–¢–†–ê:** "–ö–æ–¥ –∏–∑ test1 ‚Äî —ç—Ç–æ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, —ç—Ç–æ –∑–∞–∫–æ–Ω. –ò–∑–º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–± –ø–æ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –Ω–µ —Å–ø–æ—Å–æ–± –∏—Ö –æ—Ç—Ä–∏—Å–æ–≤–∫–∏."

**–û—Ü–µ–Ω–∫–∞ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏:** 10/10. –≠—Ç–æ—Ç –ø–ª–∞–Ω –Ω–µ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ—Å—Ç–∞ –¥–ª—è "–Ω–∞–∏—Ç–∏—è".
