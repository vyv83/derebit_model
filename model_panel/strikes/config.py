"""
Strikes Configuration Module
=============================
Централизованная конфигурация алгоритма генерации страйков Deribit.

Все параметры калибровки собраны здесь для удобного тюнинга.
Каждый параметр содержит:
- Описание что он делает
- Как его изменение влияет на результат  
- Рекомендуемые значения

ВАЖНО: Изменяйте параметры осторожно - они влияют друг на друга!
"""

from dataclasses import dataclass


@dataclass(frozen=True)
class AlgoConfig:
    """
    Центральный класс конфигурации всей системы генерации страйков.
    
    Пример использования:
    >>> from strikes.config import CONFIG
    >>> print(CONFIG.PARABOLA_STEEPNESS)
    15.0
    >>> # Чтобы изменить - создайте новый экземпляр:
    >>> my_config = AlgoConfig(PARABOLA_STEEPNESS=20.0)
    """

    # ==========================================================================
    # 1. НАСТРОЙКИ СЕТКИ (GRID FOUNDATION)
    # ==========================================================================
    #
    # Определяют БАЗОВУЮ сетку страйков - насколько густыми могут быть страйки.
    # Grid шаг растет логарифмически с ценой актива.
    #
    # Формула: step = price * multiplier
    # Пример: BTC=$100k, multiplier=0.05 → step=$5000 (страйки: 95k, 100k, 105k)
    # ==========================================================================
    
    GRID_STEP_LOW_MULTIPLIER: float = 0.025
    """
    Множитель шага для низких цен (< $10k).
    
    ↑ Увеличить: более редкие страйки для дешевых активов
    ↓ Уменьшить: более плотные страйки
    
    Пример: 0.025 → для $5000 шаг = $125
    """
    
    GRID_STEP_HIGH_MULTIPLIER: float = 0.050
    """
    Множитель шага для высоких цен (> $100k).
    
    ↑ Увеличить: более редкие страйки для дорогих активов
    ↓ Уменьшить: более плотные страйки
    
    Пример: 0.05 → для $100k шаг = $5000
    """
    
    GRID_THRESHOLD_LOW: float = 2.0
    """
    Порог переключения множителя (в log10 от цены).
    
    log10($100) ≈ 2.0 → ниже используется LOW_MULTIPLIER
    """
    
    GRID_THRESHOLD_HIGH: float = 5.0
    """
    Порог переключения на крупный шаг (в log10 от цены).
    
    log10($100000) = 5.0 → выше используется HIGH_MULTIPLIER
    """

    # ==========================================================================
    # 2. НАСТРОЙКИ ПАРАБОЛЫ (РАСПРЕДЕЛЕНИЕ СТРАЙКОВ)
    # ==========================================================================
    #
    # Парабола определяет КАК страйки распределяются вокруг ATM:
    # - В центре (ATM) - плотно
    # - На крыльях (OTM) - редко
    #
    # ВАЖНО: Эти настройки определяют ширину и форму доски!
    # ==========================================================================
    
    PARABOLA_SIGMA_MULTIPLIER: float = 1.4
    """
    Множитель ширины "конуса волатильности".
    
    ↑ Увеличить (2.0): ШИРЕ доска = больше OTM страйков
    ↓ Уменьшить (1.0): УЖЕ доска = только ATM страйки
    
    Формула: width = spot * IV * sqrt(DTE/365) * SIGMA_MULTIPLIER
    Пример: spot=$100k, IV=80%, DTE=30 → width ≈ $32k (±16k от ATM)
    """
    
    PARABOLA_SIGMA_TIME_POWER: float = 0.2
    """
    Влияние времени на ширину: sqrt(DTE) ^ TIME_POWER
    
    ↑ Увеличить (0.5): LEAPS намного шире чем weeklies
    ↓ Уменьшить (0.1): Все сроки примерно одинаковой ширины
    
    Рекомендация: 0.2-0.3 для баланса
    """
    
    PARABOLA_IV_POWER: float = 2.0
    """
    Влияние IV на размах доски.
    
    ↑ Увеличить (3.0): При высокой IV доска сильно расширяется
    ↓ Уменьшить (1.0): IV слабо влияет на ширину
    
    Рекомендация: 2.0 (квадратичная зависимость)
    """
    
    PARABOLA_DTE_DENSITY_MULTIPLIER: float = 1.0
    """
    Влияние времени на плотность в центре.
    
    ↑ Увеличить: LEAPS имеют больше страйков у ATM
    ↓ Уменьшить: Одинаковая плотность для всех сроков
    """
    
    PARABOLA_STEEPNESS: float = 15.0
    """
    Скорость разрежения к краям.
    
    ↑ Увеличить (20): Крылья ОЧЕНЬ редкие, ATM очень плотный
    ↓ Уменьшить (5):  Более равномерное распределение
    
    Визуально: 15 даёт классическую параболу
    """
    
    PARABOLA_POWER: float = 1.2
    """
    Форма кривой разрежения.
    
    = 1.0: Линейное разрежение
    > 1.0: Быстрее разрежается к краям
    < 1.0: Медленнее разрежается
    """

    # ==========================================================================
    # 3. НАСТРОЙКИ МАГНИТА (ПРИВЯЗКА К СЕТКЕ)
    # ==========================================================================
    #
    # Magnet "стягивает" индексы к ближайшим точкам сетки.
    # Чем больше DTE - тем реже страйки (шаг магнита больше).
    #
    # step=1: каждый индекс сетки (плотно)
    # step=4: каждый 4-й индекс (редко)
    # ==========================================================================
    
    MAGNET_THRESHOLD_LONG: int = 180
    """
    Порог DTE для LONG-dated options (LEAPS).
    
    Если DTE > 180 → применяется STEP_LONG (редкие страйки)
    """
    
    MAGNET_THRESHOLD_MID: int = 30
    """
    Порог DTE для MID-dated options.
    
    Если 30 < DTE <= 180 → применяется STEP_MID
    Если DTE <= 30 → применяется STEP_SHORT (плотные страйки)
    """
    
    MAGNET_STEP_LONG: int = 4
    """
    Шаг магнита для LEAPS (>180 DTE).
    
    = 4 означает каждый 4-й индекс сетки → редкие страйки
    
    Пример: сетка [100k, 102.5k, 105k, 107.5k, 110k...]
            шаг 4 → [100k, 110k, 120k...]
    """
    
    MAGNET_STEP_MID: int = 2
    """
    Шаг магнита для monthlies (30-180 DTE).
    
    = 2 означает каждый 2-й индекс → средняя плотность
    """
    
    MAGNET_STEP_SHORT: int = 1
    """
    Шаг магнита для weeklies/dailies (<30 DTE).
    
    = 1 означает каждый индекс → максимальная плотность
    """

    # ==========================================================================
    # 4. НАСТРОЙКИ ИСТОРИЧЕСКИХ СЛОЁВ (LAYER FILTERING)
    # ==========================================================================
    #
    # Страйки фильтруются по историческим данным в 3 слоя:
    #
    # Layer 1 (Recent):  последние N дней - плотная сетка
    # Layer 2 (Medium):  N-M дней назад - средняя сетка
    # Layer 3 (Old):     ещё старше - редкая сетка
    #
    # Это помогает иметь больше страйков там, где цена была недавно.
    # ==========================================================================
    
    LAYER_WINDOW_RECENT: int = 30
    """
    Окно для RECENT layer (в днях).
    
    Страйки в районе цен за последние 30 дней получают плотную сетку.
    """
    
    LAYER_WINDOW_MEDIUM: int = 180
    """
    Окно для MEDIUM layer (в днях).
    
    Страйки 30-180 дней назад получают среднюю плотность.
    """
    
    LAYER1_BUFFER_PCT: float = 0.05
    """
    Buffer для Layer 1: ±5% от исторического диапазона.
    
    Если цена была $95k-$105k → Layer 1 покрывает $90k-$110k
    """
    
    LAYER2_BUFFER_PCT: float = 0.15
    """
    Buffer для Layer 2: ±15% от исторического диапазона.
    
    Более широкий буфер для старых данных.
    """
    
    LAYER2_MIN_STEP: int = 2
    """
    Минимальный шаг для Layer 2.
    
    = 2 означает каждый 2-й индекс (прореживание)
    """
    
    LAYER3_MIN_STEP: int = 4
    """
    Минимальный шаг для Layer 3 (самые старые данные).
    
    = 4 означает каждый 4-й индекс (сильное прореживание)
    """

    # ==========================================================================
    # 5. НАСТРОЙКИ ГЛУБИНЫ ИСТОРИИ (LOOKBACKS BY TYPE)
    # ==========================================================================
    #
    # Сколько дней истории использовать для разных типов экспираций.
    # Dailies не нужна длинная история, LEAPS - нужна.
    # ==========================================================================
    
    DAILY_LOOKBACK: int = 7
    """
    Lookback для daily options (дни).
    
    Dailies используют только 7 дней истории для генерации.
    """
    
    WEEKLY_LOOKBACK: int = 30
    """
    Lookback для weekly options (дни).
    
    Weeklies используют 30 дней истории.
    """
    
    MONTHLY_LOOKBACK: int = 90
    """
    Lookback для monthly/quarterly options (дни).
    
    Monthlies и quarterlies используют 90 дней (~3 месяца) истории.
    """


# ============================================================================
# GLOBAL CONFIGURATION INSTANCE
# ============================================================================

CONFIG = AlgoConfig()
"""
Глобальный экземпляр конфигурации.

Используйте для доступа к параметрам:

>>> from strikes.config import CONFIG

# Прочитать параметр:
>>> print(CONFIG.PARABOLA_STEEPNESS)
15.0

# Для кастомной конфигурации создайте новый instance:
>>> custom = AlgoConfig(PARABOLA_STEEPNESS=20.0, MAGNET_STEP_LONG=8)

# Пример тюнинга для более плотной доски:
>>> dense_config = AlgoConfig(
...     PARABOLA_SIGMA_MULTIPLIER=2.0,  # шире конус
...     PARABOLA_STEEPNESS=10.0,         # плавнее разрежение
...     MAGNET_STEP_LONG=2               # плотнее LEAPS
... )
"""
